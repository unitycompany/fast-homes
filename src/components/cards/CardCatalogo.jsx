import React, { useState, useEffect } from "react";
import { useNavigate } from "react-router-dom";
import styled from "styled-components";
import { BsEye } from "react-icons/bs";
import { doc, updateDoc, increment } from "firebase/firestore";
import { db } from "../../services/firebaseConfig";

const Card = styled.div`
    width: 32%;
    height: auto;
    border-radius: 10px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    position: relative;
    background: #fff;
    box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.1);
    transition: all .2s ease-in-out;
    cursor: pointer;
    overflow: hidden;

    @media (max-width: 768px){
        width: 100%;
    }
    
    & button {
        position: absolute;
        top: 10px;
        right: 10px;
        padding: 5px 15px;
        border-radius: 10px;
        background: #00000020;
        backdrop-filter: blur(2px);
        color: #fff;
        cursor: pointer;
        transition: all .4s ease;
        font-size: 13px;

        &:hover {
            background-color: #fff;
            color: #000;
            transform: scale(0.95);
        }
    }

    &:hover {
        transform: scale(1.02);
    }

    & div {
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: 100%;
        color: #000;
        padding: 15px;
        border-bottom: 1px solid #00000020;

        & h4 {
            font-size: 20px;
            font-weight: 600;
            color: #000;
            font-family: var(--font--aboreto);
        }

        & span {
            font-size: 14px;
            font-weight: 400;
            opacity: 0.8;
        }
    }

`

const ImageWrapper = styled.div`
    width: 100%;
    height: 300px;
    position: relative;
    left: 0;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;

    & img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        left: 0;
        border-radius: 10px 10px 0 0;
        position: absolute;
        transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out;
    }

    & .visible {
        opacity: 1;
        transform: scale(1);
    }

    & .hidden {
        opacity: 0;
        transform: scale(1);
    }
`;


const CardDados = styled.div`
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 5px 0px!important;
    gap: 5px!important;
    border-radius: 0 0 10px 10px;
    border: none;
`

const CardDado = styled.div`
    display: flex;
    align-items: flex-start;
    flex-direction: column;
    justify-content: flex-start;
    gap: 15px;
    border: none!important;

    & svg {
        width: 40px;
        fill: #000;
    }

    & > span {
        font-size: 12px!important;
        line-height: 100%;
        font-weight: 400;
        text-align: center;
        color: #000;
        width: 100%;
    } 
    
    & p {
        font-weight: 600;
        text-align: center;
        width: 100%!important;
        font-size: 14px;
        white-space: nowrap;
        margin-top: -14px!important;
        color: #000;
    }
`

const View = styled.aside`
    position: absolute;
    width: auto;
    top: 10px;
    left: 10px;
    display: flex;
    flex-direction: row;
    align-items: center;
    justify-content: center;
    gap: 7.5px;
    background-color: #00000050;
    backdrop-filter: blur(2px);
    border-radius: 10px;
    padding: 2.5px 10px;
    color: #fff;
    transition: all .2s ease-in-out;

    & svg {
        fill: #fff;
        font-size: 12px;
    }

    & p {
        position: absolute;
        z-index: 10;
        color: #000;
        background-color: #fff;
        width: auto;
        min-width: max-content;
        left: 0px;
        top: 60px;
        border-radius: 10px;
        padding: 5px 10px;
        font-size: 10px;
        transform: scale(0);
        transition: all .2s ease-in-out;
        font-weight: 400;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);

        & b {
            font-weight: 600;
        }
    } 

    & span {
        font-size: 12px;
    }

    &:hover {
        background-color: #000;
        backdrop-filter: blur(0);
        transform: scale(0.95);
    }

    &:hover p {
        transform: scale(1);
        
    }
`

const CardCatalogo = ({ id, nome, pavimentos, area, quartos, banheiros, imagem, imagemDois, slug, views }) => {
    const [hover, setHover] = useState(false);
    const [animatedViews, setAnimatedViews] = useState(0);
    const navigate = useNavigate();

    useEffect(() => {
        if (typeof views !== 'number') return;
        let start = 0;
        const duration = 2500; // ms
        const frameRate = 5; // ms
        const totalFrames = Math.round(duration / frameRate);
        let frame = 0;
        const counter = setInterval(() => {
            frame++;
            const progress = Math.min(frame / totalFrames, 1);
            const current = Math.floor(progress * views);
            setAnimatedViews(current);
            if (progress === 1) clearInterval(counter);
        }, frameRate);
        return () => clearInterval(counter);
    }, [views]);

    const handleClick = async () => {
        if (!slug) {
            console.error(`❌ Erro: slug indefinido para a casa ${nome}`);
            return;
        }
        try {
            await updateDoc(doc(db, "catalogo", id), {views: increment(1)});
        } catch (error) {
            console.error("Erro ao atulizar as visualizações", error);
        }
        navigate(`/catalogo-de-casas/${slug}`);
    };

    return (
        <>
            <Card onClick={handleClick} onMouseEnter={() => setHover(true)} onMouseLeave={() => setHover(false)}
            >
                <ImageWrapper>
                    <img
                        src={imagem}
                        alt={nome}
                        className={hover ? "hidden" : "visible"}
                        loading="lazy"
                    />
                    <img
                        src={imagemDois}
                        alt={nome}
                        className={hover ? "visible" : "hidden"}
                        loading="lazy"
                    />
                </ImageWrapper>
                <button to={`/casas/${id}`}>Conhecer casa</button>
                <View>
                    <BsEye />
                    <span>{animatedViews.toLocaleString()}</span>
                    <p>Visualizações da casa <b>{views}</b></p>
                </View>
                <div>
                    <h4>{nome}</h4>
                    <span>{pavimentos}</span>
                </div>

                <CardDados> 
                    <CardDado>
                        <svg id="fi_4796523" enable-background="new 0 0 512.001 512.001" viewBox="0 0 512.001 512.001" xmlns="http://www.w3.org/2000/svg"><g><path d="m494.501 512h-476.981c-7.104 0-13.45-4.241-16.168-10.803-2.719-6.562-1.229-14.048 3.793-19.071l261.44-261.439c2.929-2.929 7.678-2.929 10.606 0 2.929 2.929 2.929 7.678 0 10.606l-261.439 261.439c-1.028 1.028-.781 2.148-.542 2.725s.856 1.543 2.31 1.543h27.481v-15.429c0-4.142 3.358-7.5 7.5-7.5s7.5 3.358 7.5 7.5v15.429h30.2v-15.429c0-4.142 3.358-7.5 7.5-7.5s7.5 3.358 7.5 7.5v15.429h30.2v-15.429c0-4.142 3.358-7.5 7.5-7.5s7.5 3.358 7.5 7.5v15.429h30.2v-15.429c0-4.142 3.358-7.5 7.5-7.5s7.5 3.358 7.5 7.5v15.429h30.2v-15.429c0-4.142 3.358-7.5 7.5-7.5s7.5 3.358 7.5 7.5v15.429h30.2v-15.429c0-4.142 3.358-7.5 7.5-7.5s7.5 3.358 7.5 7.5v15.429h30.2v-15.429c0-4.142 3.358-7.5 7.5-7.5s7.5 3.358 7.5 7.5v15.429h30.2v-15.429c0-4.142 3.358-7.5 7.5-7.5s7.5 3.358 7.5 7.5v15.429h30.2v-15.429c0-4.142 3.358-7.5 7.5-7.5s7.5 3.358 7.5 7.5v15.429h27.7c1.378 0 2.5-1.122 2.5-2.5v-476.979c0-1.454-.967-2.071-1.543-2.31-.577-.239-1.697-.485-2.725.542l-193.541 193.54c-2.929 2.929-7.678 2.929-10.606 0-2.929-2.929-2.929-7.678 0-10.606l193.54-193.541c5.023-5.023 12.51-6.511 19.072-3.794 6.562 2.718 10.803 9.064 10.803 16.168v476.98c0 9.65-7.851 17.5-17.5 17.5z"></path><path d="m404.501 422h-96c-4.142 0-7.5-3.358-7.5-7.5s3.358-7.5 7.5-7.5h96c1.378 0 2.5-1.122 2.5-2.5v-175.73l-178.237 178.23h49.737c4.142 0 7.5 3.358 7.5 7.5s-3.358 7.5-7.5 7.5h-49.737c-6.088 0-11.528-3.635-13.858-9.26s-1.054-12.042 3.251-16.347l178.237-178.237c4.305-4.305 10.721-5.582 16.347-3.251 5.625 2.33 9.26 7.77 9.26 13.858v175.737c0 9.65-7.851 17.5-17.5 17.5z"></path><path d="m52.501 405.001c-4.142 0-7.5-3.358-7.5-7.5v-30.001c0-4.142 3.358-7.5 7.5-7.5s7.5 3.358 7.5 7.5v30.001c0 4.143-3.358 7.5-7.5 7.5z"></path><path d="m52.501 345.001c-4.142 0-7.5-3.358-7.5-7.5v-30.001c0-4.142 3.358-7.5 7.5-7.5s7.5 3.358 7.5 7.5v30.001c0 4.143-3.358 7.5-7.5 7.5z"></path><path d="m52.501 285.001c-4.142 0-7.5-3.358-7.5-7.5v-30.001c0-4.142 3.358-7.5 7.5-7.5s7.5 3.358 7.5 7.5v30.001c0 4.143-3.358 7.5-7.5 7.5z"></path><path d="m52.501 225.001c-4.142 0-7.5-3.358-7.5-7.5v-30.001c0-4.142 3.358-7.5 7.5-7.5s7.5 3.358 7.5 7.5v30.001c0 4.143-3.358 7.5-7.5 7.5z"></path><path d="m52.501 165.001c-4.142 0-7.5-3.358-7.5-7.5v-30.001c0-4.142 3.358-7.5 7.5-7.5s7.5 3.358 7.5 7.5v30.001c0 4.143-3.358 7.5-7.5 7.5z"></path><path d="m97.502 45h-23.786c-2.263-6.384-7.331-11.452-13.715-13.715v-23.785c0-4.142-3.358-7.5-7.5-7.5s-7.5 3.358-7.5 7.5v23.785c-6.384 2.264-11.452 7.332-13.715 13.715h-23.786c-4.142 0-7.5 3.358-7.5 7.5s3.358 7.5 7.5 7.5h23.786c2.263 6.384 7.331 11.452 13.715 13.715v23.785c0 4.142 3.358 7.5 7.5 7.5s7.5-3.358 7.5-7.5v-23.785c6.384-2.263 11.452-7.331 13.715-13.715h23.786c4.142 0 7.5-3.358 7.5-7.5s-3.358-7.5-7.5-7.5zm-45.001 15c-4.136 0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5-3.364 7.5-7.5 7.5z"></path><path d="m397.502 60h-30.001c-4.142 0-7.5-3.358-7.5-7.5s3.358-7.5 7.5-7.5h30.001c4.142 0 7.5 3.358 7.5 7.5s-3.358 7.5-7.5 7.5z"></path><path d="m337.502 60h-30.001c-4.142 0-7.5-3.358-7.5-7.5s3.358-7.5 7.5-7.5h30.001c4.142 0 7.5 3.358 7.5 7.5s-3.358 7.5-7.5 7.5z"></path><path d="m277.502 60h-30.001c-4.142 0-7.5-3.358-7.5-7.5s3.358-7.5 7.5-7.5h30.001c4.142 0 7.5 3.358 7.5 7.5s-3.358 7.5-7.5 7.5z"></path><path d="m217.502 60h-30.001c-4.142 0-7.5-3.358-7.5-7.5s3.358-7.5 7.5-7.5h30.001c4.142 0 7.5 3.358 7.5 7.5s-3.358 7.5-7.5 7.5z"></path><path d="m157.502 60h-30.001c-4.142 0-7.5-3.358-7.5-7.5s3.358-7.5 7.5-7.5h30.001c4.142 0 7.5 3.358 7.5 7.5s-3.358 7.5-7.5 7.5z"></path></g></svg>
                        <span>Área (m²)</span>
                        <p>{area}</p>
                    </CardDado>

                    <CardDado> 
                        <svg id="fi_2642268" viewBox="0 0 340 340" xmlns="http://www.w3.org/2000/svg"><path d="m328.225 235.659v-96.206a3.482 3.482 0 0 0 -3.482-3.482h-42.166v-27.535h15.151a3.482 3.482 0 0 0 3.4-4.227l-7.81-35.623a11.127 11.127 0 0 0 -10.806-8.694h-21.485a11.129 11.129 0 0 0 -10.806 8.693l-7.81 35.624a3.482 3.482 0 0 0 3.4 4.227h15.152v27.535h-23.237a3.482 3.482 0 0 0 0 6.964h83.535v29.784h-49.49a3.482 3.482 0 0 0 0 6.964h49.49v29.784h-42.918a3.482 3.482 0 1 0 0 6.963h17.257a3.436 3.436 0 0 0 .914.385c14.98 3.665 13.829 17.9 13.775 18.488a3.481 3.481 0 0 0 3.463 3.838h10.989a3.482 3.482 0 0 0 3.484-3.482zm-71.2-165.582a4.124 4.124 0 0 1 4-3.222h21.487a4.124 4.124 0 0 1 4 3.222l6.882 31.395h-43.254zm10.9 38.359h7.687v27.535h-7.687zm49.325 123.741a24.638 24.638 0 0 0 -7.105-15.747h11.116v15.747z"></path><path d="m15.257 280.108h14.2a3.487 3.487 0 0 0 3.463-3.123c.108-1.025 2.883-25.158 23.841-29.951.114-.026.216-.073.324-.109h163.498c.1.031.187.074.288.1 21.007 4.766 23.787 28.937 23.894 29.957a3.481 3.481 0 0 0 3.464 3.13h14.2a3.481 3.481 0 0 0 3.482-3.481v-33.188-43.182a28.383 28.383 0 0 0 -7.316-18.988c-11.544-12.845-27.375-23.182-35.473-28.037a12.917 12.917 0 0 0 4.068-9.405 22.967 22.967 0 0 0 -7.438-16.918v-19.3a19.686 19.686 0 0 0 -19.664-19.664h-122.488a19.686 19.686 0 0 0 -19.663 19.664v19.3a22.964 22.964 0 0 0 -7.437 16.918 12.917 12.917 0 0 0 4.068 9.405c-8.1 4.855-23.929 15.192-35.473 28.037a28.385 28.385 0 0 0 -7.316 18.988v43.181 33.184a3.481 3.481 0 0 0 3.478 3.482zm243.694-40.147h-240.212v-22.533h240.212zm-232.457 33.184h-7.755v-26.22h22.523c-10.093 8.108-13.627 20.454-14.768 26.22zm224.7 0c-1.14-5.766-4.674-18.112-14.767-26.22h22.522v26.22zm-36.964-123.313h-71.9v-5.007a18.684 18.684 0 0 1 17.481-18.932c.366-.019.737-.029 1.115-.029h30.208.147c.116-.006 11.4-.428 20.1 3.707a15.789 15.789 0 0 1 8.852 14.262 6.008 6.008 0 0 1 -6.003 5.999zm-136.63-54.915h122.492a12.714 12.714 0 0 1 12.7 12.7v14.966c-9.6-3.991-20.581-3.721-21.727-3.682h-30.142q-.746 0-1.464.037a25.226 25.226 0 0 0 -20.614 12.756 25.223 25.223 0 0 0 -20.611-12.756q-.721-.038-1.467-.037h-30.141c-1.144-.039-12.127-.31-21.728 3.682v-14.966a12.714 12.714 0 0 1 12.702-12.7zm-11.287 34.652c7.206-3.426 16.266-3.72 19.164-3.72.584 0 .917.012.936.013h.146 30.208q.567 0 1.117.029a18.683 18.683 0 0 1 17.479 18.932v5.007h-71.9a6.008 6.008 0 0 1 -6-6 15.788 15.788 0 0 1 8.85-14.261zm-42.043 56.359c13.578-15.108 34.22-27 38.139-29.186.348.028.7.053 1.052.053h150.769c.355 0 .7-.025 1.052-.053 3.919 2.187 24.561 14.078 38.138 29.186a21.429 21.429 0 0 1 5.531 14.333v10.2h-240.212v-10.2a21.438 21.438 0 0 1 5.531-14.333z"></path><circle cx="280.236" cy="156.997" r="3.482"></circle><circle cx="280.236" cy="195.404" r="3.482"></circle></svg>
                        <span>Quartos</span>

                        <p>{quartos}</p>
                    </CardDado>

                    <CardDado> 
                        <svg viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" id="fi_1606212"><path d="m5.214844 302.152344c12.128906 33.355468 43.628906 55.730468 79.121094 56.199218l-16.019532 144.175782c-.265625 2.414062.507813 4.824218 2.125 6.632812 1.621094 1.808594 3.933594 2.839844 6.359375 2.839844h102.398438c2.425781 0 4.738281-1.03125 6.359375-2.839844 1.617187-1.808594 2.390625-4.21875 2.125-6.632812l-16.019532-144.175782c46.703126-.585937 84.273438-38.578124 84.335938-85.285156v-8.53125c0-4.714844-3.820312-8.535156-8.535156-8.535156h-61.757813c39.53125-26.757812 62.785157-71.742188 61.757813-119.464844 0-75.285156-53.585938-136.535156-119.464844-136.535156s-119.464844 61.25-119.464844 136.535156c-1.027344 47.722656 22.226563 92.707032 61.757813 119.464844h-61.757813c-4.714844 0-8.535156 3.820312-8.535156 8.535156v8.53125c.0195312 9.757813 1.726562 19.441406 5.042969 28.617188.058593.160156.101562.3125.171875.46875zm81.117187 192.78125 15.175781-136.535156h52.984376l15.175781 136.535156zm-60.730469-358.398438c0-65.878906 45.933594-119.46875 102.398438-119.46875s102.398438 53.589844 102.398438 119.46875c0 65.875-45.933594 119.464844-102.398438 119.464844-5.734375-.042969-11.449219-.644531-17.066406-1.796875v-40.871094c.003906-4.710937 3.820312-8.527343 8.53125-8.53125h8.535156c4.710938.003907 8.527344 3.820313 8.535156 8.53125 0 4.714844 3.820313 8.535157 8.53125 8.535157 4.714844 0 8.535156-3.820313 8.535156-8.535157-.015624-14.128906-11.46875-25.582031-25.601562-25.597656h-8.535156c-14.128906.015625-25.582032 11.46875-25.597656 25.597656v35.699219c-39.707032-16.453125-68.265626-60.601562-68.265626-112.496094zm213.332032 136.53125c-.042969 37.683594-30.582032 68.222656-68.265625 68.265625h-85.335938c-24.355469-.027343-46.851562-13.035156-59.027343-34.132812h33.429687c4.710937 0 8.53125-3.820313 8.53125-8.53125 0-4.714844-3.820313-8.535157-8.53125-8.535157h-40.421875c-1.46875-5.570312-2.222656-11.304687-2.246094-17.066406zm0 0"></path><path d="m93.867188 307.199219h8.53125c4.714843 0 8.535156-3.820313 8.535156-8.53125 0-4.714844-3.820313-8.535157-8.535156-8.535157h-8.53125c-4.714844 0-8.535157 3.820313-8.535157 8.535157 0 4.710937 3.820313 8.53125 8.535157 8.53125zm0 0"></path><path d="m68.265625 93.867188c2.265625.003906 4.4375-.898438 6.035156-2.5l34.132813-34.132813c2.21875-2.144531 3.105468-5.316406 2.328125-8.300781-.78125-2.984375-3.113281-5.3125-6.097657-6.09375-2.980468-.78125-6.15625.109375-8.296874 2.328125l-34.132813 34.132812c-2.441406 2.441407-3.171875 6.109375-1.851563 9.296875 1.324219 3.1875 4.433594 5.269532 7.882813 5.269532zm0 0"></path><path d="m159.632812 57.234375c2.21875-2.144531 3.109376-5.316406 2.328126-8.300781s-3.113282-5.3125-6.09375-6.09375c-2.984376-.78125-6.15625.109375-8.300782 2.328125l-93.867187 93.867187c-2.21875 2.140625-3.105469 5.3125-2.324219 8.296875.777344 2.984375 3.109375 5.3125 6.09375 6.09375s6.15625-.109375 8.296875-2.324219zm0 0"></path><path d="m503.464844 298.667969h-8.53125v-8.535157c0-4.710937-3.820313-8.53125-8.535156-8.53125-4.710938 0-8.53125 3.820313-8.53125 8.53125v8.535157h-17.066407v-8.535157c-.015625-14.132812-11.46875-25.582031-25.601562-25.597656h-85.332031c-14.132813.015625-25.585938 11.464844-25.601563 25.597656v8.535157h-17.066406v-8.535157c0-4.710937-3.820313-8.53125-8.53125-8.53125-4.714844 0-8.535157 3.820313-8.535157 8.53125v8.535157h-8.53125c-4.714843 0-8.535156 3.820312-8.535156 8.53125 0 4.714843 3.820313 8.535156 8.535156 8.535156h8.53125v8.53125c0 4.714844 3.820313 8.535156 8.535157 8.535156 4.710937 0 8.53125-3.820312 8.53125-8.535156v-8.53125h17.066406v119.464844c.011719 9.421875 7.648437 17.054687 17.066406 17.066406h68.269531c9.417969-.011719 17.054688-7.644531 17.066407-17.066406v-8.53125h17.066406c9.421875-.011719 17.054687-7.648438 17.066406-17.066407v-93.867187h17.066407v8.53125c0 4.714844 3.820312 8.535156 8.53125 8.535156 4.714843 0 8.535156-3.820312 8.535156-8.535156v-8.53125h8.53125c4.714844 0 8.535156-3.820313 8.535156-8.535156 0-4.710938-3.820312-8.53125-8.535156-8.53125zm-76.796875-8.535157c0-4.710937 3.820312-8.53125 8.53125-8.53125 4.714843 0 8.535156 3.820313 8.535156 8.53125v8.535157h-17.066406zm-17.066407 145.066407h-68.269531v-145.066407c.003907-4.710937 3.824219-8.527343 8.535157-8.53125h61.304687c-1.011719 2.730469-1.542969 5.617188-1.570313 8.53125zm34.132813-25.597657h-17.066406v-93.867187h17.066406zm0 0"></path><path d="m494.933594 0h-187.734375c-9.421875.0117188-17.054688 7.644531-17.066407 17.066406v204.800782c.011719 9.421874 7.644532 17.054687 17.066407 17.066406h187.734375c9.421875-.011719 17.054687-7.644532 17.066406-17.066406v-204.800782c-.011719-9.421875-7.644531-17.0546872-17.066406-17.066406zm.003906 170.667969h-85.335938v-153.601563h85.332032zm-102.402344-153.601563v153.601563h-85.335937v-153.601563zm-85.335937 204.800782v-34.132813h187.742187v34.132813zm0 0"></path><path d="m366.933594 102.398438h8.53125c4.714844 0 8.535156-3.820313 8.535156-8.53125 0-4.714844-3.820312-8.535157-8.535156-8.535157h-8.53125c-4.714844 0-8.535156 3.820313-8.535156 8.535157 0 4.710937 3.820312 8.53125 8.535156 8.53125zm0 0"></path><path d="m426.667969 102.398438h8.53125c4.714843 0 8.535156-3.820313 8.535156-8.53125 0-4.714844-3.820313-8.535157-8.535156-8.535157h-8.53125c-4.714844 0-8.535157 3.820313-8.535157 8.535157 0 4.710937 3.820313 8.53125 8.535157 8.53125zm0 0"></path></svg>
                        <span>Banheiros</span>

                        <p>{banheiros}</p>
                    </CardDado>
                </CardDados>
                
            </Card>
        </>
    )
}

export default CardCatalogo;